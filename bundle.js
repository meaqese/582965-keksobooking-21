(()=>{"use strict";window.debounce=function(e){let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>e(...n)),500)}},(()=>{const e=function(e,t){return Math.round(e+Math.random()*(t-e))};window.util={getRandRange:e,getRandElement:function(t,n=!1){const o=!1===n?t.length-1:t.length;return t[e(0,o)]},clearAllElements:function(e,t=document){const n=t.querySelectorAll(e);for(let e of n)e.remove()},clearAllChildren:function(e){e.innerHTML=""},disableAll:function(e=HTMLAllCollection){for(let t of e)t.disabled=!0},enableAll:function(e=HTMLAllCollection){for(let t of e)t.disabled=!1},clearAllPins:function(e){window.util.clearAllElements(".map__pin:not(.map__pin--main)",e)},hideCard:function(e){window.util.clearAllElements(".map__card",e)},intersection:function(e,t){const n=[];for(let o of e)t.includes(o)&&n.push(o);return n}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__filters"),n=t.querySelectorAll("select, fieldset"),o=document.querySelector(".ad-form"),i=o.querySelectorAll("fieldset");window.util.disableAll(i),window.util.disableAll(n),window.main={map:e,adForm:o,adFormFieldsets:i,mapFiltersBlocks:n,mapFilters:t}})(),(()=>{const e=function(e,t,n){e.addEventListener("load",(()=>{200===e.status?t(e.response):n(e.statusText)})),e.addEventListener("error",(()=>{n(e.statusText)})),e.addEventListener("timeout",(()=>{n("Превышено время ожидания")}))};window.backend={load:function(t,n){const o=new XMLHttpRequest;o.responseType="json",e(o,t,n),o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},send:function(t,n,o,i){const r=new XMLHttpRequest;e(r,n,o),r.open("POST",i),r.send(t)}}})(),window.data={TYPES:{palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"}},(()=>{const e=window.main.adForm,t=window.main.map.querySelector(".map__pin--main"),n=window.main.map.querySelector(".map__pins"),o=function(){const e=getComputedStyle(t);return[Math.round(parseInt(e.left,10)+parseInt(e.width,10)/2),Math.round(t.clientHeight/2+t.offsetTop)]},i=function(){window.main.map.classList.add("map--faded"),window.main.adForm.classList.add("ad-form--disabled"),window.util.disableAll(window.main.adFormFieldsets),window.util.disableAll(window.main.mapFiltersBlocks),t.style.top="375px",t.style.left="570px",window.util.clearAllPins(n),window.util.hideCard(window.main.map),e.reset(),window.filters.filters.reset(),r.value=o().join(", ")},r=e.querySelector("#address");r.value=o().join(", ");const a=e.querySelector("#room_number"),d=e.querySelector("#capacity"),c=function(e){const t=parseInt(a.value,10),n=parseInt(d.value,10);100===t&&n>0?e.setCustomValidity("Жилье не для гостей"):t<100&&0===n?e.setCustomValidity("Жилье только для гостей"):t<n?e.setCustomValidity("Количество комнат меньше количества гостей"):(a.setCustomValidity(""),d.setCustomValidity("")),e.reportValidity()};a.addEventListener("change",(function(){c(a)})),d.addEventListener("change",(function(){c(d)}));const l=e.querySelector("#type"),s=e.querySelector("#price");l.addEventListener("change",(function(){const e=l.value,t={bungalow:0,flat:1e3,house:5e3,palace:1e4};s.setAttribute("min",t[e]),s.setAttribute("placeholder",t[e]),s.reportValidity()})),s.addEventListener("input",(function(){s.reportValidity()}));const u=e.querySelector("#timein"),p=e.querySelector("#timeout"),m=function(e){u.value=e.target.value,p.value=e.target.value};u.addEventListener("change",m),p.addEventListener("change",m);const w=document.querySelector("#success").content.querySelector(".success"),f=document.querySelector("#error").content.querySelector(".error"),y=function(){document.querySelector(".success").remove(),document.removeEventListener("keydown",v),document.removeEventListener("click",_)},v=function(e){"Escape"===e.key&&y()},_=function(){y()},h=function(){document.querySelector(".error").remove(),document.removeEventListener("keydown",g),document.removeEventListener("click",E)},g=function(e){"Escape"===e.key&&h()},E=function(){h()},S=function(){const e=w.cloneNode(!0);document.body.append(e),i(),document.addEventListener("click",_),document.addEventListener("keydown",v)},q=function(){const e=f.cloneNode(!0);document.querySelector("main").append(e),document.addEventListener("click",E),document.addEventListener("keydown",g)};e.addEventListener("submit",(function(t){t.preventDefault();const n=e.getAttribute("action");window.backend.send(new FormData(e),S,q,n)})),e.querySelector(".ad-form__reset").addEventListener("click",(function(e){e.preventDefault(),i()})),window.form={mapPinMain:t,getInactivePinCoords:o}})(),(()=>{const e=window.util.clearAllChildren,t=function(){window.main.map.querySelector(".map__card").remove(),document.removeEventListener("keydown",o)},n=function(){t()},o=function(e){"Escape"===e.key&&t()},i=document.querySelector("#card").content.querySelector(".map__card");window.card={createCard:function(t){const{offer:r,author:a}=t,d=i.cloneNode(!0),c=d.querySelector(".popup__close");d.querySelector(".popup__title").textContent=r.title,d.querySelector(".popup__text--address").textContent=r.address,d.querySelector(".popup__text--price").textContent=r.price+"₽/ночь",d.querySelector(".popup__type").textContent=window.data.TYPES[r.type],d.querySelector(".popup__text--capacity").textContent=`${r.rooms} комнаты для ${r.guests} гостей`,d.querySelector(".popup__text--time").textContent=`Заезд после ${r.checkin}, выезд до ${r.checkout}`;const l=d.querySelector(".popup__features");e(l);for(let e of r.features){let t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),l.append(t)}d.querySelector(".popup__description").textContent=r.description;const s=d.querySelector(".popup__photos"),u=s.querySelector(".popup__photo");e(s);for(let e of r.photos){let t=u.cloneNode(!0);t.src=e,s.append(t)}return d.querySelector(".popup__avatar").src=a.avatar,c.addEventListener("click",n),document.addEventListener("keydown",o),d}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=window.main.map.querySelector(".map__pins");window.pin={renderPins:function(e){window.util.clearAllElements(".map__pin:not(.map__pin--main)",t),t.append(e)},createPins:function(n){const o=document.createDocumentFragment(),i=n.length>5?5:n.length;for(let r=0;r<i;r++){let i=e.cloneNode(!0);const a=n[r];i.style.left=a.location.x+"px",i.style.top=a.location.y+"px";let d=i.querySelector("img");d.src=a.author.avatar,d.alt=a.offer.title,i.addEventListener("click",(function(){window.util.clearAllElements(".map__card",window.main.map),t.after(window.card.createCard(a))})),o.appendChild(i)}return o}}})(),(()=>{const e=window.main.map,t=window.form.mapPinMain,n=Math.round(t.clientWidth/2);t.addEventListener("mousedown",(function(o){o.preventDefault();let i={x:o.clientX,y:o.clientY};if(0===o.button){const o=function(e){const o=i.x-e.clientX,r=i.y-e.clientY;i={x:e.clientX,y:e.clientY};const a=t.offsetLeft-o,d=t.offsetTop-r;d+window.map.MAP_PIN_MAIN_HEIGHT<=630&&d+window.map.MAP_PIN_MAIN_HEIGHT>=130&&(t.style.top=d+"px"),a+n>=0&&a+n<=1200&&(t.style.left=a+"px"),window.map.addressInput.value=window.map.getActivePinCoords().join(", ")},r=function(){e.removeEventListener("mousemove",o),e.removeEventListener("mouseup",r),window.map.addressInput.value=window.map.getActivePinCoords().join(", ")};e.addEventListener("mousemove",o),e.addEventListener("mouseup",r)}}))})(),(()=>{const e=window.main.map,t=window.form.mapPinMain,n=window.main.adForm.querySelector("#address");window.map={};const o=function(){return[Math.round(t.clientWidth/2+t.offsetLeft),parseInt(getComputedStyle(t).top,10)+84]},i=function(e){window.map.pins=e,window.pin.renderPins(window.pin.createPins(e)),window.util.enableAll(window.main.mapFiltersBlocks)},r=function(e){const t=document.createElement("div");t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.backgroundColor="red",t.style.textAlign="center",t.style.width="100%",t.style.height="40px",t.style.lineHeight="40px",t.style.color="white",0===e.length&&(e="Ошибка загрузки"),t.textContent=e,document.body.append(t)},a=function(){e.classList.remove("map--faded"),window.main.adForm.classList.remove("ad-form--disabled"),window.util.enableAll(window.main.adFormFieldsets),window.backend.load(i,r),n.value=o().join(", ")};t.addEventListener("mousedown",(e=>{0===e.button&&a()})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&a()})),window.map={mapPinMain:t,addressInput:n,getActivePinCoords:o,MAP_PIN_MAIN_HEIGHT:84}})(),(()=>{const e=window.main.mapFilters,t=window.debounce((e=>{window.pin.renderPins(window.pin.createPins(e)),window.util.hideCard(window.main.map)}));e.addEventListener("change",(()=>{const n=new FormData(e),o=n.get("housing-type"),i=n.get("housing-price"),r=n.get("housing-rooms"),a=n.get("housing-guests"),d=n.getAll("features"),c=window.map.pins.filter((e=>{const t=e.offer,n=t.type===o||"any"===o,c=t.rooms===window.parseInt(r)||"any"===r,l=t.guests===window.parseInt(a)||"any"===a,s=window.util.intersection(t.features,d).length===d.length||0===d.length;return n&&(()=>{switch(i){case"any":return!0;case"middle":return t.price>=1e4&&t.price<=5e4;case"low":return t.price<1e4;case"high":return t.price>5e4;default:return!1}})()&&c&&l&&s}));t(c)})),window.filters={filters:e}})()})();